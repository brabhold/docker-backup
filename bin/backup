#!/usr/bin/env bash
#source /root/.backup.env

echo "$(date "+%Y-%m-%d %H:%M:%S") mariadb-backup started"

MARIADB_BACKUP_DIR=${BACKUP_DIR}/mariadb-backup
MARIADB_DUMP_DIR=${BACKUP_DIR}/mariadb-dump
FILES_BACKUP_DIR=${BACKUP_DIR}/files

# Backup with mariadb-backup
if [ "${MARIADB_BACKUP}" = true ]; then
    echo "$(date "+%Y-%m-%d %H:%M:%S") mariadb-backup dump command to ${MARIADB_BACKUP_DIR}"
    mkdir --parents ${MARIADB_BACKUP_DIR}
    mariadb-backup --backup --host=${MARIADB_HOSTNAME} --port=${MARIADB_PORT} --user=${MARIADB_USER} --password=${MARIADB_PASSWORD} --databases="${MARIADB_DATABASE}" --stream=xbstream | gzip > ${MARIADB_BACKUP_DIR}/${MARIADB_DATABASE}--$(date +%Y-%m-%dT%H%M%S).gz
fi

# Backup with mariadb-dump
if [ "${MARIADB_DUMP}" = true ]; then
    echo "$(date "+%Y-%m-%d %H:%M:%S") mariadb-dump dump command to ${MARIADB_DUMP_DIR}"
    mkdir --parents ${MARIADB_DUMP_DIR}
    mariadb-dump --host=${MARIADB_HOSTNAME} --port=${MARIADB_PORT} --user=${MARIADB_USER} --password=${MARIADB_PASSWORD} ${MARIADB_DATABASE} | gzip > ${MARIADB_DUMP_DIR}/${MARIADB_DATABASE}--$(date +%Y-%m-%dT%H%M%S).sql.gz
fi

# Backup files
if [ ! -z "$FILES" ]; then
    mkdir --parents ${FILES_BACKUP_DIR}
    echo "$(date "+%Y-%m-%d %H:%M:%S") tar command to ${FILES_BACKUP_DIR}"
    tar -czf ${FILES_BACKUP_DIR}/$(date +%Y-%m-%dT%H%M%S).tar.gz ${FILES}
fi

# Remove older files
echo "$(date "+%Y-%m-%d %H:%M:%S") remove older files than ${BACKUP_RETENTION_DAYS} days"
find ${BACKUP_DIR} -type f -iname '*.gz' -mtime +${BACKUP_RETENTION_DAYS} -exec rm {} \;
